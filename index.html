<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Tienda Infantil</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

  <header>
    <h1>Tienda Infantil</h1>
  </header>

  <section class="banner">
    <h2>Bienvenidos a nuestra tienda</h2>
    <p>Productos adorables y seguros para los más chiquitos</p>
  </section>

  <!-- Contenedor dinámico de productos -->
  <section class="products" id="productos"></section>

  <section class="banner">
    <h2>🛒 Carrito</h2>
    <div id="cart"></div>
    <br>
    <div class="cart-actions">
      <button onclick="clearCart()">🗑️ Limpiar carrito</button>
      <button onclick="sendToWhatsApp()">📦 Enviar pedido por WhatsApp</button>
    </div>
  </section>

  <footer id="contacto">
    <p>© 2025 Mi Tienda Infantil – Todos los derechos reservados</p>
  </footer>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const sheetCSVUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRDD3exfrAx0n46egsSfOu3gNLOWaRHcSzBII-BAhMb0uk-BD_ZE03YK3NSNrbj_rDE3Nd_TWPAgdCH/pub?gid=0&single=true&output=csv";

    const prices = {};
    const stockLimits = {};
    const tempQuantities = {};
    const cart = {};

    function updateFromSheet(data) {
      const productsContainer = document.getElementById('productos');
      productsContainer.innerHTML = ''; // Limpiar productos anteriores

      data.forEach(row => {
        const name = row.name?.trim();
        const price = Number(row.price);
        const stock = Number(row.stock);
        const image = row.image?.trim();

        if (!name || isNaN(price) || isNaN(stock)) return;

        prices[name] = price;
        stockLimits[name] = stock;

        const card = document.createElement('div');
        card.className = 'product-card';

        card.innerHTML = `
          ${image ? `<img src="${image}" alt="${name}">` : ''}
          <h3>${name}</h3>
          <p>$${price}</p>
          <div class="quantity-controls">
            <button onclick="changeTempQuantity('${name}', -1)">−</button>
            <span id="temp-${name}">0</span>
            <button onclick="changeTempQuantity('${name}', 1)">+</button>
          </div>
          <button onclick="addToCart('${name}')">Agregar al carrito</button>
          <p class="stock-info">Stock disponible: <span id="stock-${name}">${stock}</span></p>
        `;

        productsContainer.appendChild(card);
      });
      console.log("Cargados:", data.map(r => r.name));
    }

    function renderCart() {
      const container = document.getElementById('cart');
      container.innerHTML = '';

      let total = 0;
      for (const item in cart) {
        if (cart[item] > 0) {
          const subtotal = cart[item] * prices[item];
          container.innerHTML += `<p>• ${item} x${cart[item]} - $${subtotal}</p>`;
          total += subtotal;
        }
      }

      if (total > 0) {
        container.innerHTML += `<p><strong>Total: $${total}</strong></p>`;
      }

      updateWhatsAppButton();
    }

    function updateWhatsAppButton() {
      const whatsappBtn = document.querySelector(".cart-actions button:last-child");
      const hasItems = Object.values(cart).some(qty => qty > 0);

      whatsappBtn.disabled = !hasItems;
      whatsappBtn.style.opacity = hasItems ? "1" : "0.6";
      whatsappBtn.style.cursor = hasItems ? "pointer" : "not-allowed";
    }

    function changeTempQuantity(name, change) {
  if (!tempQuantities[name]) tempQuantities[name] = 0;

  // Si stock es 0 no permito aumentar ni disminuir (queda en 0)
  if (stockLimits[name] === 0) return;

  const newQty = tempQuantities[name] + change;

  if (newQty >= 0 && newQty <= (stockLimits[name] || 1000)) {
    tempQuantities[name] = newQty;
    const tempSpan = document.getElementById(`temp-${name}`);
    if (tempSpan) tempSpan.textContent = newQty;
  }
}

function addToCart(name) {
  if (stockLimits[name] === 0) {
    alert(`El producto "${name}" está agotado y no puede agregarse.`);
    return;
  }

  const toAdd = tempQuantities[name] || 0;
  if (toAdd === 0) return;

  if (!cart[name]) cart[name] = 0;
  const newQty = cart[name] + toAdd;

  if (newQty <= (stockLimits[name] || 1000)) {
    cart[name] = newQty;
    tempQuantities[name] = 0;
    const tempSpan = document.getElementById(`temp-${name}`);
    if (tempSpan) tempSpan.textContent = 0;
    renderCart();
  } else {
    alert(`Solo hay ${stockLimits[name]} unidades disponibles de ${name}.`);
  }
}


    function clearCart() {
      for (const key in cart) cart[key] = 0;
      Object.keys(tempQuantities).forEach(name => {
        tempQuantities[name] = 0;
        const tempSpan = document.getElementById(`temp-${name}`);
        if (tempSpan) tempSpan.textContent = 0;
      });
      renderCart();
    }

    function sendToWhatsApp() {
      const hasItems = Object.values(cart).some(qty => qty > 0);
      if (!hasItems) {
        alert("El carrito está vacío. Agregá productos antes de enviar el pedido.");
        return;
      }

      let message = "🛒 Pedido:\n";
      for (const item in cart) {
        if (cart[item] > 0) {
          message += `• ${item} x${cart[item]}\n`;
        }
      }

      const phone = "5493794278347";
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    }

    document.addEventListener("DOMContentLoaded", () => {
      Papa.parse(sheetCSVUrl, {
        download: true,
        header: true,
        complete: function(results) {
          updateFromSheet(results.data);
          renderCart();
        }
      });
    });
  </script>

</body>
</html>
